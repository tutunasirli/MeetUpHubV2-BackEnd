@{
    ViewData["Title"] = "Profilim";
}

<div class="container mt-4">
    <div class="row">

        <!-- SOL PROFÄ°L KARTI -->
        <div class="col-lg-4 mb-4">
            <div class="profile-side-card shadow-sm">

                <div class="profile-avatar-lg">
                    <span id="avatarLetter">A</span>
                </div>

                <h4 class="text-center mt-3 mb-0" id="fullName">Ä°sim Soyisim</h4>
                <p class="text-muted text-center small mb-2" id="email">
                    email@example.com
                </p>

                <p class="text-center small text-secondary">
                    KayÄ±t: <span id="registerDate">-</span>
                </p>

                <div class="d-flex justify-content-around mt-4">
                    <div class="text-center">
                        <strong id="eventCount">0</strong>
                        <div class="small text-muted">Etkinlik</div>
                    </div>
                    <div class="text-center">
                        <strong>â­ <span id="userRating">0.0</span></strong>
                        <div class="small text-muted">Puan</div>
                    </div>
                </div>

                <button type="button" class="btn btn-outline-danger mt-3 mt-md-0"
        data-bs-toggle="modal" data-bs-target="#editProfileModal">
    âœï¸ Profili DÃ¼zenle
</button>

            </div>
        </div>

        <!-- SAÄ Ä°Ã‡ERÄ°K -->
        <div class="col-lg-8">

            <!-- HAKKIMDA -->
            <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <h5 class="fw-semibold">ğŸ™‹â€â™€ï¸ HakkÄ±mda</h5>
        <p class="text-muted mb-0" id="aboutText">
            YÃ¼kleniyor...
        </p>
    </div>
</div>


            <!-- ETKÄ°NLÄ°KLER -->
            <h4 class="mb-3">ğŸ“… Etkinliklerim</h4>

            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <button class="nav-link active">Gelecek</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link">GeÃ§miÅŸ</button>
                </li>
            </ul>

            <div id="eventsContainer" class="row g-4"></div>
        </div>
    </div>
</div>


<div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header">
        <h5 class="modal-title">Profili DÃ¼zenle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>

      <div class="modal-body">
        <label class="form-label fw-semibold">HakkÄ±mda</label>
        <textarea id="aboutInput" class="form-control" rows="4"
                  placeholder="Kendinden kÄ±saca bahset..."></textarea>
        <small class="text-muted d-block mt-2">
          Ã–rn: â€œKahve severim, yeni insanlarla tanÄ±ÅŸmayÄ± seviyorum.â€
        </small>
      </div>

      <div class="modal-footer">
        <button class="btn btn-light" data-bs-dismiss="modal">VazgeÃ§</button>
        <button id="saveAboutBtn" class="btn btn-danger">Kaydet</button>
      </div>
    </div>
  </div>
</div>

<!-- FOOTER -->
<footer class="profile-footer mt-5">
    <p>Â© 2025 MeetUpHub</p>
    <div class="social-icons">
        <i class="fab fa-instagram"></i>
        <i class="fab fa-twitter"></i>
        <i class="fab fa-linkedin"></i>
    </div>
</footer>

@section Scripts {
<script>
document.addEventListener("DOMContentLoaded", async () => {

    const token = localStorage.getItem("jwt_token");
    if (!token) return;

    // ğŸ”¹ PROFÄ°L BÄ°LGÄ°LERÄ°
    const profileRes = await fetch("http://localhost:5292/api/profile/me", {
        headers: { "Authorization": `Bearer ${token}` }
    });

    const profile = await profileRes.json();

    document.getElementById("fullName").innerText =
        `${profile.name} ${profile.surname}`;

    document.getElementById("email").innerText = profile.email;

    document.getElementById("registerDate").innerText =
        new Date(profile.registrationDate).toLocaleDateString();

    document.getElementById("avatarLetter").innerText =
        profile.name.charAt(0).toUpperCase();

    const events = profile.events ?? [];
    document.getElementById("eventCount").innerText = events.length;

    // âœ… HAKKIMDA GÃ–STER
    document.getElementById("aboutText").innerText =
        profile.about && profile.about.trim() !== ""
            ? profile.about
            : "HenÃ¼z bir aÃ§Ä±klama eklenmemiÅŸ.";

    // â­ PROFÄ°L PUANI
    try {
        const ratingRes = await fetch(
            `http://localhost:5292/api/rating/${profile.id}`,
            { headers: { "Authorization": `Bearer ${token}` } }
        );

        if (ratingRes.ok) {
            const rating = await ratingRes.json();
            document.getElementById("userRating").innerText =
                rating.toFixed(1);
        }
    } catch {}

    // ğŸ”¹ ETKÄ°NLÄ°KLER
    const container = document.getElementById("eventsContainer");

    if (events.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center p-5 empty-state">
                <img src="https://cdn-icons-png.flaticon.com/512/747/747310.png" width="80" class="mb-3"/>
                <h5>HenÃ¼z bir etkinliÄŸe katÄ±lmadÄ±n</h5>
                <p class="text-muted">Yeni insanlarla tanÄ±ÅŸmak iÃ§in etkinlikleri keÅŸfet!</p>
                <a href="/" class="btn btn-danger">Etkinlikleri KeÅŸfet</a>
            </div>`;
    } else {
        events.forEach(ev => {
            container.innerHTML += `
            <div class="col-md-6">
                <div class="card event-card h-100 shadow-sm border-0">
                    <div class="card-body">
                        <span class="badge bg-danger mb-2">${ev.category}</span>
                        <h5 class="fw-semibold">${ev.title}</h5>
                        <p class="text-muted small">${ev.description ?? ""}</p>
                    </div>
                </div>
            </div>`;
        });
    }

    // ===============================
    // âœï¸ HAKKIMDA KAYDET (EKSÄ°K OLAN ADIM)
    // ===============================
    document.getElementById("saveAboutBtn").addEventListener("click", async () => {

        const about = document.getElementById("aboutInput").value;

        const res = await fetch("http://localhost:5292/api/profile/me/about", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ about })
        });

        if (!res.ok) {
            alert("HakkÄ±mda gÃ¼ncellenemedi.");
            return;
        }

        // âœ… EkranÄ± anÄ±nda gÃ¼ncelle
        document.getElementById("aboutText").innerText =
            about.trim() !== "" ? about : "HenÃ¼z bir aÃ§Ä±klama eklenmemiÅŸ.";

        // âœ… Modal kapat
        const modalEl = document.getElementById("editProfileModal");
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
    });

});
</script>
}

}
