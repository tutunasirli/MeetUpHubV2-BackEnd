@model MeetUpHubV2.Frontend.Models.WaitingRoomViewModel
@{
    ViewData["Title"] = "Etkinlik Bekleme OdasÄ±";
}

<div class="container py-5 mt-5">
    <div class="row g-4">

        <!-- SOL TARAF - BEKLEME ODASI -->
        <div class="col-lg-7 col-md-6">
            <div class="card shadow-sm border-0 h-100">

                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">Etkinlik Bekleme OdasÄ±</h4>
                </div>

                <div class="card-body p-4">
                    <h5 class="card-title fw-bold text-dark">Etkinlik Åehri: @Model.CityName</h5>

                    <p class="card-text text-muted">
                        Kategori: @Model.CategoryDisplayName |
                        Zaman Dilimi: @Model.TimeSlotDisplay |
                        Kapasite: @Model.CurrentUserCount / @Model.Capacity KiÅŸi
                    </p>

                    <hr />

                    <!-- BEKLEME MESAJI -->
                    <div id="waitingMessage" class="text-center p-4">
                        <div class="spinner-border text-danger" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h5 class="mt-3">EÅŸleÅŸme bekleniyor...</h5>
                        <p class="text-muted">Oda dolduÄŸunda oylama ekranÄ±na yÃ¶nlendirileceksiniz.</p>
                    </div>

                    <!-- EÅLEÅME BULUNDU MESAJI -->
                    <div id="matchMessage" class="alert alert-success mt-4 d-none" role="alert">
                        Harika! Oda doldu, eÅŸleÅŸme tamamlandÄ±. Oylama odasÄ±na yÃ¶nlendiriliyorsunuz...
                    </div>

                    <!-- ODADAN AYRIL -->
                    <div class="d-grid mt-4">
                        <button id="leaveButton" class="btn btn-outline-danger">
                            <i class="fas fa-sign-out-alt me-2"></i> Odadan AyrÄ±l
                        </button>
                    </div>
                </div>

            </div>
        </div>




        <!-- SAÄ TARAF - ETKÄ°NLÄ°K KURALLARI -->
        <div class="col-lg-5 col-md-6">
            <div class="card shadow-sm border-0 h-100">

                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i> Etkinlik KurallarÄ±
                    </h4>
                </div>

                <div class="card-body p-4">
                    <p class="text-muted">
                        MeetUpHubâ€™Ä± gÃ¼venli, saygÄ±lÄ± ve keyifli bir ortamda kullanmak iÃ§in lÃ¼tfen aÅŸaÄŸÄ±daki kurallara dikkat ediniz:
                    </p>

                    <ul class="list-unstyled">

                        <li class="mb-3">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            DiÄŸer katÄ±lÄ±mcÄ±lara karÅŸÄ± her zaman nazik ve saygÄ±lÄ± olun.
                        </li>

                        <li class="mb-3">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            KÃ¼fÃ¼r, hakaret, nefret sÃ¶ylemi veya taciz iÃ§eren davranÄ±ÅŸlarda bulunmayÄ±n.
                        </li>

                        <li class="mb-3">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            GerÃ§ek ve doÄŸru bilgiler paylaÅŸmaya Ã¶zen gÃ¶sterin.
                        </li>

                        <li class="mb-3">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Spam yapmak, sohbeti sabote etmek veya kullanÄ±cÄ±larÄ± rahatsÄ±z etmek yasaktÄ±r.
                        </li>

                        <li class="mb-3">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Gizlilik Ã¶nemlidir â€” kiÅŸisel bilgilerinizi paylaÅŸÄ±rken dikkatli olun.
                        </li>

                        <li class="mb-3">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            GÃ¼venlik sorunlarÄ±nÄ± veya uygunsuz davranÄ±ÅŸlarÄ± platform yÃ¶neticisine bildirin.
                        </li>

                    </ul>
                </div>

            </div>
        </div>

    </div>
</div>




@section Scripts {
<script>
document.addEventListener("DOMContentLoaded", function () {

    const roomId = "@Model.RoomId";

    const token = localStorage.getItem("jwt_token") || localStorage.getItem("token");
    if (!token) {
        alert("Oturumunuz sona ermiÅŸ olabilir. LÃ¼tfen tekrar giriÅŸ yapÄ±n.");
        window.location.href = "/Account/Login";
        return;
    }

    const apiBase = "http://localhost:5292";
    const hubUrl = `${apiBase}/roomhub`;

    // ===============================
    // ğŸ”¹ ODA BÄ°LGÄ°SÄ°NÄ° YÃœKLE
    // ===============================
    async function loadRoomInfo() {
        try {
            const res = await fetch(`${apiBase}/api/rooms/${roomId}`, {
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            });

            if (!res.ok) {
                console.error("Room bilgisi alÄ±namadÄ±");
                return;
            }

            const room = await res.json();

            document.querySelector(".card-title").innerText =
                "Etkinlik Åehri: " + room.city;

            document.querySelector(".card-text").innerText =
                `Kategori: ${room.category} | Zaman Dilimi: ${room.timeSlot} | Kapasite: ${room.userIds.length} / ${room.capacity}`;

            if (room.isFull) {
                document.getElementById("waitingMessage").style.display = "none";
                document.getElementById("matchMessage").classList.remove("d-none");
            }

        } catch (err) {
            console.error("loadRoomInfo error:", err);
        }
    }

    // ğŸ‘‰ SAYFA AÃ‡ILINCA Ã‡AÄIR
    loadRoomInfo();

    // ===============================
    // ğŸ”¹ SIGNALR
    // ===============================
    const connection = new signalR.HubConnectionBuilder()
        .withUrl(hubUrl, { accessTokenFactory: () => token })
        .withAutomaticReconnect([0, 2000, 5000, 10000])
        .build();

    connection.on("MatchFound", function (data) {
        document.getElementById("waitingMessage").style.display = "none";
        document.getElementById("matchMessage").classList.remove("d-none");

        sessionStorage.setItem("votingRoomId", data.roomId);
        sessionStorage.setItem("votingOptions", JSON.stringify(data.options));

        setTimeout(() => {
            window.location.href = "/Matching/VotingRoom";
        }, 1500);
    });

    async function startSignalR() {
        try {
            await connection.start();
            await connection.invoke("JoinRoomGroup", parseInt(roomId));
            await connection.invoke("RegisterUserConnection");
        } catch (err) {
            console.error("SignalR error:", err);
            setTimeout(startSignalR, 3000);
        }
    }

    startSignalR();

    // ===============================
    // ğŸ”¹ ODADAN AYRIL
    // ===============================
    document.getElementById("leaveButton").addEventListener("click", async function () {

        try {
            const res = await fetch(`${apiBase}/api/matching/leave`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ roomId: parseInt(roomId) })
            });

            if (res.ok) {
                await connection.stop();
                window.location.href = "/";
            } else {
                alert("Odadan ayrÄ±lamadÄ±");
            }
        } catch (err) {
            alert("Hata: " + err.message);
        }
    });

});
</script>
}



